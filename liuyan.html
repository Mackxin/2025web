<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匿名留言板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        secondary: '#3498db',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-primary mb-2">匿名留言板</h1>
            <p class="text-gray-600">无需登录，直接留言，数据安全存储在Gitee</p>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- 留言表单 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-primary flex items-center">
                    <i class="fa fa-pencil-square-o mr-2"></i> 发表留言
                </h2>
                
                <form id="messageForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">昵称 (选填)</label>
                        <input type="text" id="name" placeholder="您的昵称" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary/50">
                    </div>
                    
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言内容 <span class="text-red-500">*</span></label>
                        <textarea id="message" rows="4" placeholder="请输入您的留言..." 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary/50"
                                  required></textarea>
                        <div class="flex justify-between mt-1">
                            <span id="charCount" class="text-xs text-gray-500">0/300</span>
                        </div>
                    </div>
                    
                    <button type="submit" id="submitBtn" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2">
                        <i class="fa fa-paper-plane"></i>
                        <span>提交留言</span>
                    </button>
                </form>
            </div>

            <!-- 留言列表 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-primary flex items-center">
                        <i class="fa fa-comments mr-2"></i> 留言列表
                    </h2>
                    <button id="refreshBtn" class="text-sm text-gray-600 hover:text-secondary transition-colors">
                        <i class="fa fa-refresh mr-1"></i> 刷新
                    </button>
                </div>
                
                <div id="loadingState" class="py-12 text-center hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-secondary"></div>
                    <p class="mt-2 text-gray-600">加载中...</p>
                </div>
                
                <div id="emptyState" class="py-12 text-center">
                    <i class="fa fa-comment-o text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">暂无留言，成为第一个留言的人吧！</p>
                </div>
                
                <div id="errorState" class="py-12 text-center hidden">
                    <i class="fa fa-exclamation-triangle text-4xl text-yellow-500 mb-3"></i>
                    <p class="text-red-500 mb-2" id="errorText">加载失败</p>
                    <p class="text-sm text-gray-500 mb-4" id="errorDetails">请检查网络连接</p>
                    <button id="retryBtn" class="text-sm bg-secondary text-white px-3 py-1 rounded hover:bg-secondary/90">
                        重试
                    </button>
                </div>
                
                <div id="messagesList" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 hidden">
                    <!-- 留言将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 调试信息区域 -->
        <div class="mt-8 bg-gray-100 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                <i class="fa fa-bug mr-1"></i> 调试信息
            </h3>
            <pre id="debugLog" class="text-xs text-gray-600 bg-gray-50 p-3 rounded h-32 overflow-y-auto"></pre>
        </div>
    </div>

    <!-- 提交状态弹窗 -->
    <div id="submitModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div id="modalLoading" class="text-center py-6">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-secondary mb-4"></div>
                <p class="text-gray-700">正在提交留言...</p>
            </div>
            
            <div id="modalSuccess" class="text-center py-6 hidden">
                <div class="inline-block bg-green-100 rounded-full p-3 mb-4">
                    <i class="fa fa-check text-2xl text-green-500"></i>
                </div>
                <p class="text-gray-700 font-medium">留言提交成功！</p>
                <button id="modalSuccessBtn" class="mt-4 bg-secondary text-white px-4 py-2 rounded hover:bg-secondary/90">
                    确定
                </button>
            </div>
            
            <div id="modalError" class="text-center py-6 hidden">
                <div class="inline-block bg-red-100 rounded-full p-3 mb-4">
                    <i class="fa fa-times text-2xl text-red-500"></i>
                </div>
                <p class="text-gray-700 font-medium mb-2">提交失败</p>
                <p class="text-sm text-gray-500 mb-4" id="modalErrorText">请稍后重试</p>
                <p class="text-xs text-gray-400 mb-4" id="modalErrorDetails"></p>
                <button id="modalRetryBtn" class="bg-secondary text-white px-4 py-2 rounded hover:bg-secondary/90">
                    重试
                </button>
            </div>
        </div>
    </div>

    <script>
        // 配置信息 - 请确保这些信息正确
        const CONFIG = {
            owner: 'baoxiaobao',                // Gitee用户名
            repo: 'liuyan',                  // 仓库名称
            issueId: 21574922,               // Issue ID
            accessToken: 'b190584c44e5881c651f20ebb03c561d',  // 访问令牌
            
            // 代理列表 - 将按顺序尝试
            proxies: [
                'https://cors.bridged.cc/',
                'https://cors-anywhere.azm.workers.dev/',
                'https://api.allorigins.win/raw?url=',
                'https://cors.sh/',
                '' // 无代理（最后尝试）
            ],
            
            // API端点
            api: {
                comments: (owner, repo, issueId) => 
                    `https://gitee.com/api/v5/repos/${owner}/${repo}/issues/${issueId}/comments`
            }
        };

        // DOM元素引用
        const elements = {
            form: document.getElementById('messageForm'),
            nameInput: document.getElementById('name'),
            messageInput: document.getElementById('message'),
            charCount: document.getElementById('charCount'),
            submitBtn: document.getElementById('submitBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            retryBtn: document.getElementById('retryBtn'),
            messagesList: document.getElementById('messagesList'),
            loadingState: document.getElementById('loadingState'),
            emptyState: document.getElementById('emptyState'),
            errorState: document.getElementById('errorState'),
            errorText: document.getElementById('errorText'),
            errorDetails: document.getElementById('errorDetails'),
            debugLog: document.getElementById('debugLog'),
            
            // 弹窗元素
            submitModal: document.getElementById('submitModal'),
            modalLoading: document.getElementById('modalLoading'),
            modalSuccess: document.getElementById('modalSuccess'),
            modalError: document.getElementById('modalError'),
            modalSuccessBtn: document.getElementById('modalSuccessBtn'),
            modalRetryBtn: document.getElementById('modalRetryBtn'),
            modalErrorText: document.getElementById('modalErrorText'),
            modalErrorDetails: document.getElementById('modalErrorDetails')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('页面加载完成，初始化应用...');
            bindEvents();
            loadMessages();
        });

        // 绑定事件处理函数
        function bindEvents() {
            // 表单提交
            elements.form.addEventListener('submit', (e) => {
                e.preventDefault();
                submitMessage();
            });
            
            // 字符计数
            elements.messageInput.addEventListener('input', () => {
                const length = elements.messageInput.value.length;
                elements.charCount.textContent = `${length}/300`;
                if (length > 300) {
                    elements.messageInput.value = elements.messageInput.value.substring(0, 300);
                    elements.charCount.textContent = '300/300';
                }
            });
            
            // 刷新和重试按钮
            elements.refreshBtn.addEventListener('click', loadMessages);
            elements.retryBtn.addEventListener('click', loadMessages);
            
            // 弹窗按钮
            elements.modalSuccessBtn.addEventListener('click', () => {
                elements.submitModal.classList.add('hidden');
            });
            
            elements.modalRetryBtn.addEventListener('click', () => {
                elements.modalError.classList.add('hidden');
                elements.modalLoading.classList.remove('hidden');
                submitMessage();
            });
        }

        // 加载留言
        function loadMessages() {
            logDebug('开始加载留言...');
            showState('loading');
            
            const apiUrl = CONFIG.api.comments(CONFIG.owner, CONFIG.repo, CONFIG.issueId) + 
                          `?access_token=${CONFIG.accessToken}&sort=created&direction=desc`;
            
            // 尝试使用代理加载
            tryProxiesForRequest(apiUrl, 'GET')
                .then(response => {
                    logDebug(`加载成功，收到 ${response.length} 条留言`);
                    
                    if (response.length === 0) {
                        showState('empty');
                        return;
                    }
                    
                    renderMessages(response);
                    showState('content');
                })
                .catch(error => {
                    logDebug(`加载失败: ${error.message}`);
                    elements.errorText.textContent = '加载留言失败';
                    elements.errorDetails.textContent = error.message || '请检查配置和网络连接';
                    showState('error');
                });
        }

        // 提交留言
        function submitMessage() {
            const name = elements.nameInput.value.trim() || '匿名访客';
            const message = elements.messageInput.value.trim();
            
            if (!message) return;
            
            logDebug(`准备提交留言: 昵称=${name}, 内容=${message.substring(0, 20)}...`);
            
            // 显示提交弹窗
            elements.submitModal.classList.remove('hidden');
            elements.modalLoading.classList.remove('hidden');
            elements.modalSuccess.classList.add('hidden');
            elements.modalError.classList.add('hidden');
            
            // 构建留言内容
            const content = `**${name}**\n\n${message}\n\n_${new Date().toLocaleString()}_`;
            
            // 构建API URL和数据
            const apiUrl = CONFIG.api.comments(CONFIG.owner, CONFIG.repo, CONFIG.issueId);
            const requestData = {
                body: content
            };
            
            // 尝试使用代理提交
            tryProxiesForRequest(apiUrl, 'POST', requestData)
                .then(response => {
                    logDebug('留言提交成功');
                    elements.modalLoading.classList.add('hidden');
                    elements.modalSuccess.classList.remove('hidden');
                    
                    // 重置表单
                    elements.form.reset();
                    elements.charCount.textContent = '0/300';
                    
                    // 重新加载留言
                    loadMessages();
                })
                .catch(error => {
                    logDebug(`提交失败: ${error.message}`);
                    elements.modalLoading.classList.add('hidden');
                    elements.modalError.classList.remove('hidden');
                    elements.modalErrorText.textContent = '提交失败';
                    elements.modalErrorDetails.textContent = error.message || '请检查配置和网络连接';
                });
        }

        // 渲染留言列表
        function renderMessages(messages) {
            elements.messagesList.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'border-b border-gray-100 pb-4 last:border-0';
                
                // 解析昵称
                let nickname = '匿名访客';
                const nicknameMatch = msg.body.match(/\*\*(.*?)\*\*/);
                if (nicknameMatch && nicknameMatch[1]) {
                    nickname = nicknameMatch[1];
                }
                
                // 解析内容
                let content = msg.body.replace(/\*\*(.*?)\*\*/, '').replace(/\n\n_.*?_/, '').trim();
                
                messageElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-secondary/10 flex items-center justify-center text-secondary mr-2">
                                <i class="fa fa-user"></i>
                            </div>
                            <span class="font-medium">${escapeHtml(nickname)}</span>
                        </div>
                        <span class="text-xs text-gray-500">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-gray-700 text-sm">${formatContent(escapeHtml(content))}</div>
                `;
                
                elements.messagesList.appendChild(messageElement);
            });
        }

        // 尝试使用多个代理进行请求
        function tryProxiesForRequest(url, method = 'GET', data = null) {
            return new Promise((resolve, reject) => {
                // 递归尝试代理
                function attemptProxy(proxyIndex) {
                    if (proxyIndex >= CONFIG.proxies.length) {
                        return reject(new Error('所有代理尝试失败，请检查网络或更换代理'));
                    }
                    
                    const proxy = CONFIG.proxies[proxyIndex];
                    const fullUrl = proxy ? `${proxy}${url}` : url;
                    
                    logDebug(`尝试代理 ${proxyIndex + 1}/${CONFIG.proxies.length}: ${proxy || '无代理'}`);
                    logDebug(`请求URL: ${fullUrl}`);
                    
                    // 创建请求选项
                    const requestOptions = {
                        method: method,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.accessToken}`,
                            'X-Gitee-Api-Version': 'v5',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
                        },
                        timeout: 15000
                    };
                    
                    // 如果有数据，添加到请求体
                    if (data && method === 'POST') {
                        requestOptions.body = JSON.stringify(data);
                    }
                    
                    // 创建超时控制器
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        logDebug(`代理 ${proxyIndex + 1} 请求超时`);
                        attemptProxy(proxyIndex + 1);
                    }, 15000);
                    
                    // 发送请求
                    fetch(fullUrl, {
                        ...requestOptions,
                        signal: controller.signal
                    })
                    .then(response => {
                        clearTimeout(timeoutId);
                        logDebug(`代理 ${proxyIndex + 1} 响应状态: ${response.status}`);
                        
                        if (!response.ok) {
                            return response.text().then(text => {
                                let errorMsg = `HTTP错误: ${response.status}`;
                                try {
                                    const jsonError = JSON.parse(text);
                                    if (jsonError.message) errorMsg += ` - ${jsonError.message}`;
                                } catch (e) {
                                    errorMsg += ` - ${text.substring(0, 100)}`;
                                }
                                throw new Error(errorMsg);
                            });
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        logDebug(`代理 ${proxyIndex + 1} 请求成功`);
                        resolve(data);
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        
                        if (error.name === 'AbortError') {
                            logDebug(`代理 ${proxyIndex + 1} 请求超时`);
                        } else {
                            logDebug(`代理 ${proxyIndex + 1} 请求失败: ${error.message}`);
                        }
                        
                        // 尝试下一个代理
                        attemptProxy(proxyIndex + 1);
                    });
                }
                
                // 开始尝试第一个代理
                attemptProxy(0);
            });
        }

        // 显示不同状态
        function showState(state) {
            elements.loadingState.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.messagesList.classList.add('hidden');
            
            switch (state) {
                case 'loading':
                    elements.loadingState.classList.remove('hidden');
                    break;
                case 'empty':
                    elements.emptyState.classList.remove('hidden');
                    break;
                case 'error':
                    elements.errorState.classList.remove('hidden');
                    break;
                case 'content':
                    elements.messagesList.classList.remove('hidden');
                    break;
            }
        }

        // 记录调试信息
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            elements.debugLog.textContent += `[${timestamp}] ${message}\n`;
            elements.debugLog.scrollTop = elements.debugLog.scrollHeight;
        }

        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 30) return `${diffDays}天前`;
            
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        // 转义HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 格式化内容
        function formatContent(content) {
            return content.replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
